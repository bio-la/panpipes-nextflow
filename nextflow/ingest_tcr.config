process.executor = 'local'

params {


    outdir       = './results'
    mode         = 'ingest'

    submission_file = '/Users/mylenemarianagonzalesandre/Development/HiWi/Panpipes/data/vdj_dataset/submission_nf_vdj_2.csv'
    cellranger_column_conversion = '/Users/mylenemarianagonzalesandre/Development/HiWi/Panpipes/ingest/panpipes-nextflow/panpipes/resources/metrics_summary_col_conversion.tsv'
    sample_prefix = 'cite_seq_vdj'

    resources = [
        threads_high   : 3,
        threads_medium : 2,
        threads_low    : 1
    ]


    ingest = [

        project           : 'multimodal_vdj',
        sample_prefix     : 'cite_seq_vdj',
        use_existing_h5mu : false,

        metadatacols      : 'sample_id,disease_state,tissue,preservation_method,celltype',
        concat_join_type  : 'outer',
        background_suffix : '_bg',


        modalities: [
            rna  : true,
            prot : true,
            bcr  : true,
            tcr  : true,
            atac : false
        ],

        // optional: external barcodes
        barcode_mtd: [
            include      : false,
            path         : null,
            metadatacols : null
        ],


        protein_metadata_table       : '/Users/mylenemarianagonzalesandre/Development/HiWi/Panpipes/data/vdj_dataset/protein_metadata.txt',
        index_col_choice             : null,
        load_prot_from_raw           : false,
        subset_prot_barcodes_to_rna  : false,


        plot_10X_metrics             : true,


        //  Doublet detection on RNA modality
        scr: [
            run                        : true,
            expected_doublet_rate      : 0.06,
            sim_doublet_ratio          : 2,
            n_neighbours               : 20,
            min_counts                 : 2,
            min_cells                  : 3,
            min_gene_variability_pctl  : 85,
            n_prin_comps               : 30,
            use_thr                    : true,
            call_doublets_thr          : 0.25
        ],

        custom_genes_file      : '/Users/mylenemarianagonzalesandre/Development/HiWi/Panpipes/ingest/panpipes-nextflow/panpipes/resources/qc_genelist_1.0.csv',
        calc_proportions       : 'hb,mt,rp,ig',
        score_genes            : 'MarkersNeutro',
        ccgenes                : '/Users/mylenemarianagonzalesandre/Development/HiWi/Panpipes/ingest/panpipes-nextflow/panpipes/resources/cell_cycle_genes.tsv',

        plotqc_grouping_var    : 'sample_id',

        plotqc_rna_metrics     : 'doublet_scores,pct_counts_mt,pct_counts_rp,pct_counts_hb,pct_counts_ig',
        plotqc_prot_metrics    : 'total_counts,log1p_total_counts,n_adt_by_counts,pct_counts_isotype',
        prot_metrics_per_prot  : 'total_counts,log1p_total_counts,n_cells_by_counts,mean_counts',

        identify_isotype_outliers : true,
        isotype_upper_quantile    : 90,
        isotype_n_pass            : 2,

        plotqc_atac_metrics : 'n_genes_by_counts,total_counts,pct_fragments_in_peaks,atac_peak_region_fragments,atac_mitochondrial_reads,atac_TSS_fragments',

        //
        // BCR / TCR â€“ params for distance and identification of clones
        //
        ir_dist: [
            metric   : null,
            sequence : null
        ],

        clonotype_definition: [
            receptor_arms : null,
            dual_ir       : null,
            within_group  : null
        ],

        plotqc_rep_metrics : [
            'is_cell',
            'extra_chains',
            'clonal_expansion',
            'rep:receptor_type',
            'rep:receptor_subtype',
            'rep:chain_pairing',
            'rep:multi_chain'
        ],

        assess_background     : true,
        downsample_background : true,
        downsample_target_n_cells : 20000,

        channel_col           : 'sample_id',
        save_norm_prot_mtx    : false,

        //----------------------
        // Protein normalization
        //----------------------
        normalisation_methods : 'clr,dsb',

        clr_margin            : 0,
        quantile_clipping     : true
    ]
}

profiles {
    docker {
        docker.enabled        = true
        conda.enabled         = false
        singularity.enabled   = false
        podman.enabled        = false
        process.container     = 'mari3ga/single_cell:v1'
    }

    conda {
        docker.enabled        = false
        singularity.enabled   = false
        podman.enabled        = false
        conda.enabled         = true
        process.conda         = "/Users/mylenemarianagonzalesandre/miniconda3/envs/spatial-transcriptomics"
    }
}

process {
    cpus  = 2
    memory = '4 GB'
    time   = '4h'
    
    withLabel: 'limit_blas' {
        env.OMP_NUM_THREADS       = { task.cpus }
        env.OPENBLAS_NUM_THREADS  = { task.cpus }
        env.MKL_NUM_THREADS       = { task.cpus }
        // useful extras depending on the backend:
        env.NUMEXPR_NUM_THREADS   = { task.cpus }
        env.BLIS_NUM_THREADS      = { task.cpus }
        env.VECLIB_MAXIMUM_THREADS= { task.cpus }
    }
}
